<!--
 * @Author: liuwanyong liuwanyong2018@gmail.com
 * @Date: 2022-10-15 16:16:27
 * @LastEditors: liuwanyong liuwanyong2018@gmail.com
 * @LastEditTime: 2022-11-08 19:00:53
 * @FilePath: /brower/README.md
 * @Description: 这是默认设置,请设置`customMade`, 打开koroFileHeader查看配置 进行设置: https://github.com/OBKoro1/koro1FileHeader/wiki/%E9%85%8D%E7%BD%AE##
-->

# brower

浏览器概念知识构建

## 历史

浏览器目前是多进程架构的技术选型，由单进程的技术历史发展过来的。
以前的硬件不行，CPU，GPU，内存，闪存，带宽啊等等都不行，以前的网络服务的数据实体也简单，图文而已。
某个技术的发展都是跟整个生态技术的发展息息相关的。

## 线程与进程

### 线程

线程应该是跟硬件层面的 cpu 线程有关联的，但是不讨论低层的执行到底有木有关系
。我们的范畴只存在于软件技术领域。这个线程可以理解为一段可以独立运行的代码逻辑
的实际运行。
单单只看它本身木得意义，有意义的是，在时间尺度和内存尺度看管理它的进程，以及
同时并行运行的其他线程，就有意义了。
还有一个概念就是并行运行。
其实可想一个对比就是单线程运行几个独立不干扰的逻辑，跟多个线程运行它们，为了效率。
线程之间共享同一进程的内存，数据。

### 进程

进程，在我看来就是一个独立的程序从开始运行到结束
整个过程中，它用到的内存，线程活动管理，代码，数据操作等等所有的
总和。官方叫程序的运行环境。

#### 特色特性

-  多线程并行运行，某个线程出问题，整个进程出问题，会崩掉了。
-  进程之间互相独立，互不干扰。
-  进程终结，它的内存也被回收了。
-  线程之间共享进程的数据。

#### 单进程技术浏览器

运行的任务：

-  多个页面的网络发收，数据解析，渲染，交互等。
-  插件的运行。
-  对内存的读写等。
   出现任何一个问题，都要堵塞或者崩溃进程，所有页面都卡顿或者崩溃。
   放开读写给插件和进程页面，很危险。
   页面关闭，内存回收不干净，内存泄漏，越来越卡顿。

#### 多进程技术架构

主进程，
GUI 进程，网络进程，插件进程，渲染进程。这五种进程做分工协作
。

##### 主进程

人机交互，其他进程的管理，读写内存，界面显示等。它才有读写权限。安全。

##### 渲染进程

一般情况下，，，一个页面一个渲染进程，互相不干扰，关了就回收内存，很干净。包括 HTML
，css,js 转换为页面的所有逻辑都是它处理。排版引擎
blink,js 引擎 v8。
对读写
权限很严，沙箱模式下运行的。

##### GPU 进程

为了 Css 的
3D 效果，出现的，后来网页和默认的 UI 界面都是它绘制了。

##### 网络进程

网络资源的加载。

##### 插件进程

隔离插件和页面的运行影响，插件容易崩溃。

##### 评价

体验很好，流畅，安全，互相不影响。
但是，很多进程都是公共资源的副本，比如渲染进程，浪费内存。
而且各个模块之间的耦合度很高，扩展性差，关系复杂。升级困难。

## 从浏览器输入 url 开始到页面展示

##输入，浏览器主线程

浏览器主线程管交互，同时管理浏览器的页面之外的区域的
交互功能。
输入的内容，是关键词的话，就会自动搜索相关的 URL 结果
。

### 建立 TCP

输入的是 url,或者 host（自动补全成 url），就会 开始找缓存，查询是否有记录。
有记录有数据，不过期，就直接返回这个数据了。
没有的话，开始 DNS 查询。
有木有缓存记录，有就用，没有就找根 DNS 查顶级域名服务器，顶级再找下一级的域名服务器，域名都是分级组成的。就好比图书馆的检索系统，大类有小类，小类里面还有小类。
找到 IP 地址。
然后
开始下一步就是，建立 TCP 链接。假如是 HTTPS 协议，这里还要先进行 TLS 连接。

### 返回的数据情况

TCP3 次握手之后，浏览器创建请求行，请求头，把 cookie 这类的数据也会带上，然后就发送出去了。
响应，可能是 301,302。这意味着，重定向，响应头里的 location 带有新 URL，然后开始从头开始发请求。
还有其他的响应，不成功的就说明终止了。
200 的成功的，还要看响应头的 content-type，假如不是 xml 这种 html 数据，说明也结束了。
是 html，这时候，浏览器主进程会开启渲染进程，可能不会开启，
判断依据是 a 页面打开的 b 页面，ab 是同一域名的，同一协议的，这就是同一个站点了。

### 导航流程终结

开启渲染进程之后，主进程通知 渲染进程开始提交文档。渲染进程开始跟网络进场建立连接，然后
数据传输，完成后，渲染进程返回确认提交消息给主进程。
主进程更新 history，前进后退,地址栏显示这些。导航流程完成。

### 渲染阶段

接下来就是渲染阶段了。一旦渲染进程解析好了 HTML css js，资源也加载好了，渲染进程回通知主进程，主进程会停止页面 tab 上的 loading 状态。

## 渲染过程

-  html 解析，生成 DOM 树
-  CSS 文件的获取和解析，生成 CSSSheet，然后跟 DOM 树结合作用生成渲染树。
-  JS 执行，对应的 DOM 操作也加入到渲染树上。

### 生成 DOM 树

对 HTML 进行词法分析语法分析，同时遇到外部资源的 link 链接也会请求。
生成 DOM 树，就是父子兄弟关系的 树形结构。

### 样式计算

源于 HTML 上的 link 链接的 Css 文件，还有 style 标签的内容，还有标签的内联样式的解析。
然后就把这些内容解析成浏览器可以 理解的数据结构。
可以在浏览器里面输入 document.styleSheets。

-  解析 css 文件的代码，生成 cssSheet，这个跟css树有概念区别，这个更标准。
-  转换 css 属性里面的属性值，标准化，变量，关键词等化为标准的数据。
-  计算出每个 DOM 节点的样式
   这里需要遵循 CSS 的层叠规则和继承规则了。优先级，覆盖结果，继承属性等等场景。
-  创建布局树
   有很多的不可见的元素，比如 header 标签，比如说 display 为 none 的元素。
   要创建一个只有 可见的节点的布局树。
   遍历 DOM 树，不可见的节点都忽略，生成了布局树。
